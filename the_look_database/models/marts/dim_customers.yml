version: 2

models:
  - name: dim_customers
    description: "A Kimball-style dimension table containing one row per unique customer. It combines static attributes (demographics) with calculated measures (LTV, order counts) to provide a 360-degree view of user behavior."
    columns:
      - name: user_id
        description: "The natural key for the user, sourced directly from the production database."
        data_tests:
          - unique
          - not_null

      - name: user_sk
        description: "The surrogate key (hash) used to uniquely identify the record in the warehouse."
        data_tests:
          - unique
          - not_null

      - name: user_first_name
        description: "The first name of the customer."
        data_tests:
          - not_null

      - name: user_last_name
        description: "The last name of the customer."
        data_tests:
          - not_null

      - name: user_email
        description: "The primary email address used by the customer for account communication."
        data_tests:
          - not_null

      - name: user_age
        description: "The age of the customer at the time of account creation."

      - name: user_gender
        description: "The self-reported gender of the user."
        data_tests:
          - not_null

      - name: user_state
        description: "The state or province associated with the user's primary address."

      - name: user_street_address
        description: "The full street address for shipping and billing."
        data_tests:
          - not_null

      - name: user_postal_code
        description: "The ZIP or postal code for the user's primary address."
        data_tests:
          - not_null

      - name: user_city
        description: "The city associated with the user's primary address."
        data_tests:
          - not_null

      - name: user_country
        description: "The country of residence for the user."
        data_tests:
          - not_null

      - name: user_traffic_source
        description: "The marketing channel (e.g., Search, Organic, Email) that first acquired this user."
        data_tests:
          - not_null

      - name: user_longitude
        description: "The longitudinal coordinate of the user's primary address."
        data_tests:
          - not_null

      - name: user_latitude
        description: "The latitudinal coordinate of the user's primary address."
        data_tests:
          - not_null

      - name: user_created_at
        description: "The UTC timestamp when the user account was first created."
        data_tests:
          - not_null

      - name: completed_orders
        description: "The total count of orders placed by this user with a 'Complete' status."
        data_tests:
          - not_null

      - name: last_order_completed_at
        description: "The timestamp of the most recent order successfully completed by the user."
        data_tests:
          - conditional_not_null:
              arguments:
                condition: "completed_orders > 0"

      - name: returned_orders
        description: "The total count of orders that were subsequently returned by the user."
        data_tests:
          - not_null

      - name: last_order_returned_at
        description: "The timestamp of the most recent order marked as 'Returned'."
        data_tests:
          - conditional_not_null:
              arguments:
                condition: "returned_orders > 0"

      - name: cancelled_orders
        description: "The total count of orders that were cancelled before fulfillment."
        data_tests:
          - not_null

      - name: last_order_cancelled_at
        description: "The timestamp of the most recent order marked as 'Cancelled'."
        data_tests:
          - conditional_not_null:
              arguments:
                condition: "cancelled_orders > 0"

      - name: total_orders
        description: "The lifetime count of all orders placed by the user, regardless of status."
        data_tests:
          - not_null

      - name: first_order_at
        description: "The timestamp of the very first order placed by this user (customer acquisition date)."
        data_tests:
          - conditional_not_null:
              arguments:
                condition: "total_orders > 0"

      - name: last_order_at
        description: "The timestamp of the most recent order activity."
        data_tests:
          - conditional_not_null:
              arguments:
                condition: "total_orders > 0"

      - name: user_ltv
        description: "Lifetime Value: The total gross revenue generated by this user to date."
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: user_items_purchased
        description: "The total quantity of individual items purchased across all orders."
        data_tests:
          - not_null
          - dbt_utils.expression_is_true:
              arguments:
                expression: ">= 0"

      - name: is_active_customer
        description: "A boolean flag indicating if the user has placed an order within the last 90 days."
        data_tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - TRUE
                  - FALSE
